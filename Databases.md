# 数据库
1. 关系型数据存储、文件系统存储、键值存储、可扩展记录存储、文档存储

2. 后四种(文件系统存储、键值存储、可扩展记录存储、文档存储)是非关系型数据库，但文件系统存储也不能说是NoSQL

3. 后三种(键值存储、可扩展记录存储、文档存储)是NoSQL


## 0. 比较著名存储引擎介绍
#### TC

混合 Key-Value 存储引擎，其中包括 HASH Table 和 B+ Tree 的实现。

#### LevelDB
是一个使用 C++ 开发的嵌入式的 Key-Value 存储引擎，数据结构采用了 LSM-Tree

很容易的在上层构建 MVCC 系统或者事务模型，这对数据库来说非常重要。

#### B-tree 家族
大多数传统的单机数据库的存储引擎都选择了 B+Tree

第三方存储引擎比较著名的纯 B+Tree 实现是 LMDB

LMDB 选择在内存映像文件 (mmap) 实现 B+Tree，而且使用了 Copy-On-Write 实现了 MVCC 实现并发事务无锁读的能力

#### 混合引擎
最著名的应该是 WiredTiger，大概是2014年被 MongoDB 收购，现在成为了 MongoDB 的默认存储引擎。

WiredTiger 内部有 LSM-Tree 和 B-tree 两种实现，对外提供相同的接口

#### Hash table一般指哈希表
散列表（Hash table，也叫哈希表），是根据**键值(Key value)**而直接进行访问的数据结构。也就是说，它通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度。这个映射函数叫做散列函数，存放记录的数组叫做散列表。

给定表M，存在函数f(key)，对任意给定的关键字值key，代入函数后若能得到包含该关键字的记录在表中的地址，则称**表M为哈希(Hash）表，函数f(key)为哈希(Hash) 函数。**

## 1. 关系型数据存储
### 1.1 关系型数据库的范式
**1NF(第一范式)**

指数据库表中的每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性。

简而言之，第一范式就是无重复的列。例如，由“职工号”“姓名”“电话号码”组成的表(一个人可能有一部办公电话和一部移动电话)，这时将其规范化为1NF可以将电话号码分为“办公电话”和“移动电话”两个属性，即职工(职工号，姓名，办公电话，移动电话)。

**2NF(第二范式)**

满足第二范式(2NF)必须先满足第一范式(1NF)

如果关系模型R为第一范式，并且R中的每一个非主属性完全函数依赖于R的某个候选键，则称R为第二范式模式

例如，在选课关系表(学号，课程号，成绩，学分)，关键字为组合关键字(学号，课程号)，但由于非主属性学分仅依赖于课程号，对关键字(学号，课程号)只是部分依赖，而不是完全依赖，因此此种方式会导致数据冗余以及更新异常等问题，解决办法是将其分为两个关系模式：学生表(学号，课程号，分数)和课程表(课程号，学分)

**3NF(第三范式)**

如果关系模型R是第二范式，且每个非主属性都不传递依赖于R的候选键，则称R是第三范式的模式。

以学生表(学号，姓名，课程号，成绩)为例，其中学生姓名无重名，所以该表有两个候选码(学号，课程号)和(姓名，课程号)，故存在函数依赖：学号――>姓名，(学号，课程号)――>成绩，唯一的非主属性成绩对码不存在部分依赖，也不存在传递依赖，所以属性属于第三范式。

**BCNF(BC范式)**

在第三范式的基础上，如果关系模型R是第一范式，且每个属性都不传递依赖于R的候选键，那么称R为BCNF的模式。

仓库管理关系表(仓库号，存储物品号，管理员号，数量)，满足一个管理员只在一个仓库工作；一个仓库可以存储多种物品，则存在如下关系：

(仓库号，存储物品号)――>(管理员号，数量)

(管理员号，存储物品号)――>(仓库号，数量)

所以，(仓库号，存储物品号)和(管理员号，存储物品号)都是仓库管理关系表的候选码，表中唯一非关键字段为数量，它是符合第三范式的。但是，由于存在如下决定关系：

(仓库号)――>(管理员号)

(管理员号)――>(仓库号)

即**存在关键字段决定关键字段**的情况，因此其不符合BCNF。

把仓库管理关系表分解为两个关系表仓库管理表(仓库号，管理员号)和仓库表(仓库号，存储物品号，数量)，这样这个数据库表是符合BCNF的，并消除了删除异常、插入异常和更新异常。

### 1.2 ACID特性（关系型数据库遵循ACID规则）
根据ACID特性选择数据库

原子性：要么执行完所有事务，要么都不执行（不可分割）

一致性：事务开始时，所有状态需一致，并发事务也得像串行执行结果一样。一个事务改变了a，那么必须得改变b

隔离性：事务在执行时，像是数据库中唯一在进行的操作，即并发交错执行的事务互不干扰。并发的事务之间不会互相影响，如果一个事务要访问的数据正在被另外一个事务修改，只要另外一个事务未提交，它所访问的数据就不受未提交事务的影响。

持久性：当事务执行成功以后，将永久改变系统的状态，不可逆转

### 1.3 何时选择关系型数据库
1. 数据之间存在很强的关联关系：一对多或者多对多关系

2. 需要保证事务的完整性（ACID）

无需上述两点特性时，非关系型数据库是更好的选择


## 2 非关系型数据储存
### 2.1 文件存储系统（以文件形式存储，也是一种数据库系统，但不是NoSQL。）

GFS、TFS、FastDFS、Ceph、MogileFS……适合“无需维护大量关系，写一次、读多次”的场景

**比如存储图片，只需写一次，之后每次都是读**

### NoSQL
NoSQL，指的是非关系型的数据库。NoSQL有时也称作Not Only SQL的缩写，是对不同于传统的关系型数据库的数据库管理系统的统称。

用于超大规模数据的存储。（例如谷歌或Facebook每天为他们的用户收集万亿比特的数据）

对NoSQL最普遍的解释是"非关联型的"，强调Key-Value Stores和文档数据库的优点

**NoSQL 引擎在不同场景下不可互换**

**常见NoSQL类别：键值存储、可扩展记录存储、文档存储**

### 2.2 键值存储
Memcached、Redis、Amazon DynamoDB、Simple DB……
对数据做单一的键值索引，索引存储在内存中;
数据模型简单，可扩展性和性能高;
数据一致性有同步复制和异步复制两种，强一致性、弱一致性；
强一致性与关系型数据库有同样的缺点，受节点数量、地理位置、网络环境影响

**类似于dict，可以用python的Dict搞定，但因为数据量大，且分布在多个系统上的，所以用这些数据库**

### 2.3 可扩展记录存储
又称宽列存储或表格式数据库系统;

Google BigTable、Facebook Cassandra、HBase……

节点之间可以拆分行列的数据模型

**用主键对行进行拆分或分片，把列分为不同的组，不同的组放在不同节点上**

**列拆分与关系型数据库类似，需自行定义，行拆分由引擎自动完成**

异步复制达到最终一致性，时效性可能会差，少则毫秒，多则小时

记录：一条消息就是一条记录，比如mysql里的一行就是一条记录

**可扩展记录：就是这条记录可以被扩展，但是比如mysql里的记录，就无法被扩展。即关系型数据库的记录是不可扩展的**


### 2.4 文档型存储
MongoDB、CouchDB、Amazon DynamoDB、CouchBase……

数据模型被称为“文档”

不支持ACID特性，异步复制提供最终一致

即高效又复杂

**比如存储python的对象**


## 3. MapReduce 分布式计算引擎
![](https://github.com/SkewwG/architecture/blob/master/Picture/MapReduce.png?raw=true)
Hadoop，高度可扩展的文件系统，兼具存储、检索、分布式处理

MapReduce 基本原理

**基本原理：和Python的Reduce和Map基本相同**

核心思想：lisp语言的 map和reduce函数

分布式计算引擎的基石：↓
Input 输入

Splitting 拆分（随便拆分），将数据分摊开

Mapping：将数据拿去计算

Shuffling：派发，将同类的数据派发到一起

Reducing：

Final Result


## 4.目标
**能够为系统挑选一个合适的数据库，灵活组合多种存储引擎**

### 数据库选型考虑因素
数据量（系统发展速度）

响应时间

读写比率

数据之间的关系

数据结构

数据管理要求